@{
    ViewData["Title"] = "Payment Checkout";
}

<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-6 col-md-8">
            <div class="card shadow-lg border-0" style="border-radius: 15px;">
                <div class="card-header text-white text-center py-4" style="background: linear-gradient(135deg, #5D5FEF 0%, #7879F1 100%); border-radius: 15px 15px 0 0;">
                    <h3 class="mb-0">
                        <i class="fas fa-credit-card me-2"></i>
                        Complete Payment
                    </h3>
                </div>
                <div class="card-body p-4">
                    <!-- Payment Details -->
                    <div class="mb-4 p-3" style="background: var(--light-bg); border-radius: 10px;">
                        <h5 class="mb-3" style="color: var(--dark-color);">
                            <i class="fas fa-info-circle me-2"></i>Payment Details
                        </h5>
                        <div class="d-flex justify-content-between mb-2">
                            <span><strong>Rental ID:</strong></span>
                            <span class="text-muted">@ViewBag.RentalId</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span><strong>Amount:</strong></span>
                            <span class="text-primary fw-bold fs-4">$@ViewBag.Amount</span>
                        </div>
                    </div>

                    <!-- Payment Form -->
                    <form id="payment-form">
                        <!-- hidden inputs -->
                        <input type="hidden" id="rentalId" value="@ViewBag.RentalId" />
                        <input type="hidden" id="amount" value="@ViewBag.Amount" />

                        <div class="mb-4">
                            <label for="card-element" class="form-label fw-bold">
                                <i class="fas fa-credit-card me-2"></i>Card Information
                            </label>
                            <div id="card-element" class="form-control" style="height: 45px; padding: 12px; border: 2px solid #E5E5E5; border-radius: 8px;">
                                <!-- Stripe Card Element -->
                            </div>
                        </div>

                        <div id="card-errors" class="text-danger mb-3" role="alert"></div>

                        <button id="submit-button" class="btn btn-primary-custom w-100 py-3" type="submit" style="font-size: 1.1rem;">
                            <span id="button-text">
                                <i class="fas fa-lock me-2"></i>Pay $@ViewBag.Amount Securely
                            </span>
                            <span id="spinner" class="spinner-border spinner-border-sm d-none" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </span>
                        </button>
                    </form>

                    <div class="text-center mt-3">
                        <small class="text-muted">
                            <i class="fas fa-shield-alt me-1"></i>
                            Your payment is secure and encrypted
                        </small>
                    </div>
                </div>
               
            </div>
            <!-- Test Cards Info -->
            <div class="card mt-3 border-0" style="background: #FFF3CD; border-radius: 10px;">
                <div class="card-body">
                    <h6 class="mb-2"><i class="fas fa-info-circle me-2"></i>Test Cards:</h6>
                    <small>
                        <strong>Success:</strong> 4242 4242 4242 4242<br>
                        <strong>Decline:</strong> 4000 0000 0000 0002<br>
                        Any future date, any CVV, any ZIP
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        const stripe = Stripe('@ViewBag.StripePublishableKey');
        const elements = stripe.elements();

        const cardElement = elements.create('card', {
            style: {
                base: {
                    fontSize: '16px',
                    color: '#2C2D3F',
                    fontFamily: 'Cairo, sans-serif',
                    '::placeholder': { color: '#8B8D97' }
                },
                invalid: { color: '#dc3545' }
            }
        });
        cardElement.mount('#card-element');

        const form = document.getElementById('payment-form');
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const spinner = document.getElementById('spinner');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitButton.disabled = true;
            buttonText.classList.add('d-none');
            spinner.classList.remove('d-none');

            try {
                const rentalId = '@ViewBag.RentalId';
                const amount = parseFloat('@ViewBag.Amount');

                console.log("DEBUG: rentalId", rentalId, "amount", amount);

                if (isNaN(amount) || amount <= 0) {
                    throw new Error('Amount must be greater than zero');
                }

                // 1️⃣ إنشاء PaymentIntent في السيرفر
                const response = await fetch('/Payment/CreatePaymentIntent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rentalId, amount, paymentType: 1 })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to create payment intent');
                }

                console.log("DEBUG: PaymentIntent created", data);

                // 2️⃣ تأكيد الدفع على Stripe
                const { error, paymentIntent } = await stripe.confirmCardPayment(data.clientSecret, {
                    payment_method: {
                        card: cardElement,
                        billing_details: {
                            name: "Test User" // مهم للتأكيد
                        }
                    }
                });

                console.log("DEBUG: Stripe confirm result", { error, paymentIntent });

                if (error) {
                    document.getElementById('card-errors').textContent = error.message;
                    throw new Error(error.message);
                }

                // 3️⃣ تأكيد الدفع على السيرفر
                const confirmResponse = await fetch('/Payment/ConfirmPayment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ paymentId: data.paymentId, paymentIntentId: paymentIntent.id })
                });

                const confirmData = await confirmResponse.json();

                console.log("DEBUG: Server confirm result", confirmData);

                if (confirmResponse.ok) {
                    window.location.href = '/Payment/Success';
                } else {
                    throw new Error(confirmData.error || 'Failed to confirm payment');
                }

            } catch (err) {
                console.error("DEBUG: Payment error", err);
                document.getElementById('card-errors').textContent = err.message;
                submitButton.disabled = false;
                buttonText.classList.remove('d-none');
                spinner.classList.add('d-none');
            }
        });
    </script>
}
